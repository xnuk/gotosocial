# vim: sw=2
name: Build
on: push

jobs:
  bin:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version-file: ./go.mod
    - run: VERSION="${{ github.sha }}" ./scripts/build.sh
    - name: upx
      run: >
        curl -sSL https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz |
        tar --xz -xOf - upx-4.2.4-amd64_linux/upx > upx &&
        chmod +x upx &&
        strip ./gotosocial &&
        ./upx -q ./gotosocial
    - run: sha256sum ./gotosocial > ./gotosocial.sha256sum
    - uses: actions/upload-artifact@v4
      with:
        name: bin
        path: |
          ./gotosocial
          ./gotosocial.sha256sum

  web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        cache: yarn
        cache-dependency-path: ./web/source/yarn.lock
    - run: >
        cd ./web/source/ &&
        yarn install &&
        yarn ts-patch install &&
        yarn build
    - run: rm -rf ./web/source/
    - uses: actions/upload-artifact@v4
      with:
        name: web
        path: ./web

